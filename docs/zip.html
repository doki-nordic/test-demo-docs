<html>

<header>
    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script-->
    <script src="ZipServer.js"></script>
</header>

<body style="font-family: Verdana, Geneva, Tahoma, sans-serif;">


    <script>

        let zs = null;
        let zipId = null;
        let zipUrl = 'latest.zip';

        async function doTheJobOLD() {

            zs = new ZipServer();
            await zs.register();

            zip = await new Promise((resolve, reject) => {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", zipUrl, true);
                xhr.responseType = 'arraybuffer';
                xhr.addEventListener('load', function () {
                    if (xhr.status === 200) {
                        console.log(xhr.response);
                        console.log(new Blob([xhr.response]));
                        resolve(xhr.response);
                    } else {
                        console.log(xhr.status);
                        reject(Error("Download error!"));
                    }
                })
                xhr.addEventListener('progress', function (e) {
                    console.log(e.loaded);
                })
                xhr.send();
            });

            let id = zs.addZip(zip).id;

            console.log('ZIP added ', id);
        }

        const workerScriptURL = 'overlayWorker.js';

        let reg = null;

        async function doTheJob() {

            reg = await navigator.serviceWorker.register(workerScriptURL);

            console.log(reg.active);

            setTimeout(async () => {
                let w = await getWorker();
                console.log('Sending message to worker: ', w);
                w.postMessage({ id: 'test' });
            }, 1000);

        }

        async function getWorker() {
            while (!reg || !reg.active || !reg.active.scriptURL.toString().endsWith(workerScriptURL)) {
                console.log('Waiting for worker...');
                console.log(!reg, !reg.active, reg.active.scriptURL, workerScriptURL, reg.active.scriptURL.toString().endsWith(workerScriptURL));
                await new Promise(r => setTimeout(r, 300));
            }
            return reg.active;
        }

        doTheJob();

    </script>

</body>

</html>